; Listing generated by Microsoft (R) Optimizing Compiler Version 19.38.33134.0 

include listing.inc

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	?genv@@3UGlobalExternVariables@@A		; genv
PUBLIC	?load_address@@3_KA				; load_address
_BSS	SEGMENT
?load_address@@3_KA DQ 01H DUP (?)			; load_address
_BSS	ENDS
A$A	SEGMENT
?genv@@3UGlobalExternVariables@@A	ORG $+12		; genv
A$A	ENDS
PUBLIC	?StubEntryPoint@@YAXXZ				; StubEntryPoint
; Function compile flags: /Odtp
; File D:\licenta\mypacker\stub\stub.cpp
_TEXT	SEGMENT
?StubEntryPoint@@YAXXZ PROC				; StubEntryPoint

; 34   :     load_address = (unsigned long long) StubEntryPoint - genv.RVA_to_stub_entry_point;

  00000	8b 05 00 00 00
	00		 mov	 eax, DWORD PTR ?genv@@3UGlobalExternVariables@@A
  00006	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:?StubEntryPoint@@YAXXZ ; StubEntryPoint
  0000d	48 2b c8	 sub	 rcx, rax
  00010	48 8b c1	 mov	 rax, rcx
  00013	48 89 05 00 00
	00 00		 mov	 QWORD PTR ?load_address@@3_KA, rax ; load_address

; 35   :     // first the stub needs to locate the compressed data
; 36   :     // thus, it needs to find the offsets to the sections of
; 37   :     // the executable it is currently injecting itself into
; 38   :     //
; 39   : 
; 40   :     /*
; 41   :     // starting from the load address it needs to get to the e_lfanew offset
; 42   :     unsigned long long * offset = load_address;
; 43   :     offset += 0x3C;
; 44   : 
; 45   :     // now thw offset needs to jump to the address written here
; 46   :     offset += *offset;
; 47   : 
; 48   :     // finally, in order to get to the packed data, it needs to find the sections
; 49   :     // in order to manage that, i find the size of optional header and jump over it
; 50   :     offset += 0x14; // current offset = size of optional header
; 51   :     offset += *offset + 0x2; // current offset = section headers
; 52   : 
; 53   :     // the stub reached the start of the compressed data
; 54   :     // i need the size of the sections
; 55   :     //
; 56   :     */
; 57   : 
; 58   : }

  0001a	c3		 ret	 0
?StubEntryPoint@@YAXXZ ENDP				; StubEntryPoint
_TEXT	ENDS
END
